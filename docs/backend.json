{
  "entities": {
    "Contact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Contact",
      "type": "object",
      "description": "Represents a customer contact for an organization.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the contact."
        },
        "organizationId": {
          "type": "string",
          "description": "Reference to the parent Organization."
        },
        "name": {
          "type": "string",
          "description": "The contact's name."
        },
        "email": {
          "type": "string",
          "description": "The contact's email address.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "The contact's phone number."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the contact was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "organizationId",
        "name",
        "email"
      ]
    },
    "Organization": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Organization",
      "type": "object",
      "description": "Represents a business organization using the platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the organization."
        },
        "companyName": {
          "type": "string",
          "description": "The name of the company."
        },
        "logoUrl": {
          "type": "string",
          "description": "URL of the company logo hosted on Cloudinary.",
          "format": "uri"
        },
        "email": {
          "type": "string",
          "description": "The organization's email address.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "The organization's phone number."
        },
        "address": {
          "type": "string",
          "description": "The organization's physical address."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the organization was created.",
          "format": "date-time"
        },
        "emailSubject": {
          "type": "string",
          "description": "The subject line for emails sent by the organization."
        },
        "emailBody": {
          "type": "string",
          "description": "The body text for emails sent by the organization."
        },
        "smsContent": {
          "type": "string",
          "description": "The content of SMS messages sent by the organization."
        },
        "smsApiKey": {
          "type": "string",
          "description": "The organization's public API key for the SMS service."
        },
        "smsSenderId": {
          "type": "string",
          "description": "The organization's sender ID for the SMS service."
        }
      },
      "required": [
        "id",
        "companyName",
        "email"
      ]
    },
    "Receipt": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Receipt",
      "type": "object",
      "description": "Represents a receipt generated by an organization.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the receipt."
        },
        "organizationId": {
          "type": "string",
          "description": "Reference to Organization. (Relationship: Organization 1:N Receipt)"
        },
        "receiptNumber": {
          "type": "string",
          "description": "A unique, sequential number for the receipt."
        },
        "customerName": {
          "type": "string",
          "description": "The name of the customer."
        },
        "customerEmail": {
          "type": "string",
          "description": "The customer's email address.",
          "format": "email"
        },
        "customerPhoneNumber": {
          "type": "string",
          "description": "The customer's phone number."
        },
        "items": {
          "type": "array",
          "description": "A list of items or services included in the receipt.",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string"
              },
              "quantity": {
                "type": "number"
              },
              "price": {
                "type": "number"
              }
            },
            "required": [
              "name",
              "quantity",
              "price"
            ]
          }
        },
        "discount": {
          "type": "number",
          "description": "The discount applied to the receipt (optional)."
        },
        "tax": {
          "type": "number",
          "description": "The tax applied to the receipt (optional)."
        },
        "totalAmount": {
          "type": "number",
          "description": "The total amount of the receipt."
        },
        "pdfUrl": {
          "type": "string",
          "description": "URL of the generated PDF receipt.",
          "format": "uri"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the receipt was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "organizationId",
        "receiptNumber",
        "customerName",
        "customerEmail",
        "totalAmount"
      ]
    },
    "EmailLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "EmailLog",
      "type": "object",
      "description": "Represents a log of emails sent by the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the email log entry."
        },
        "receiptId": {
          "type": "string",
          "description": "Reference to Receipt. (Relationship: Receipt 1:1 EmailLog)"
        },
        "recipient": {
          "type": "string",
          "description": "The recipient's email address.",
          "format": "email"
        },
        "status": {
          "type": "string",
          "description": "The status of the email (sent, delivered, failed)."
        },
        "errorMessage": {
          "type": "string",
          "description": "Error message if the email failed to send (optional)."
        },
        "sentAt": {
          "type": "string",
          "description": "Timestamp indicating when the email was sent.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "receiptId",
        "recipient",
        "status",
        "sentAt"
      ]
    },
    "SmsLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SmsLog",
      "type": "object",
      "description": "Represents a log of SMS messages sent by the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SMS log entry."
        },
        "receiptId": {
          "type": "string",
          "description": "Reference to Receipt. (Relationship: Receipt 1:1 SmsLog)"
        },
        "phoneNumber": {
          "type": "string",
          "description": "The phone number the SMS was sent to."
        },
        "status": {
          "type": "string",
          "description": "The status of the SMS message."
        },
        "apiResponse": {
          "type": "string",
          "description": "The response from the SMS API."
        },
        "sentAt": {
          "type": "string",
          "description": "Timestamp indicating when the SMS was sent.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "receiptId",
        "phoneNumber",
        "status",
        "sentAt"
      ]
    },
    "SystemErrorLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SystemErrorLog",
      "type": "object",
      "description": "Represents a log of system errors for debugging and monitoring.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the system error log entry."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp indicating when the error occurred.",
          "format": "date-time"
        },
        "message": {
          "type": "string",
          "description": "A descriptive error message."
        },
        "stackTrace": {
          "type": "string",
          "description": "The stack trace associated with the error."
        },
        "component": {
          "type": "string",
          "description": "The component or module where the error occurred."
        }
      },
      "required": [
        "id",
        "timestamp",
        "message"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/organizations/{organizationId}",
        "definition": {
          "entityName": "Organization",
          "schema": {
            "$ref": "#/backend/entities/Organization"
          },
          "description": "Stores organization profiles. Organizations can only access their own profile. Super admins can view all organizations.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/contacts/{contactId}",
        "definition": {
          "entityName": "Contact",
          "schema": {
            "$ref": "#/backend/entities/Contact"
          },
          "description": "Stores customer contacts for an organization. Organization owners can manage their own contacts.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "contactId",
              "description": "The unique ID of the contact."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/receipts/{receiptId}",
        "definition": {
          "entityName": "Receipt",
          "schema": {
            "$ref": "#/backend/entities/Receipt"
          },
          "description": "Stores receipts belonging to an organization. Includes denormalized 'organizationId' for authorization independence.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "receiptId",
              "description": "The unique ID of the receipt."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/receipts/{receiptId}/emailLogs/{emailLogId}",
        "definition": {
          "entityName": "EmailLog",
          "schema": {
            "$ref": "#/backend/entities/EmailLog"
          },
          "description": "Stores email logs associated with a receipt.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "receiptId",
              "description": "The unique ID of the receipt."
            },
            {
              "name": "emailLogId",
              "description": "The unique ID of the email log."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/receipts/{receiptId}/smsLogs/{smsLogId}",
        "definition": {
          "entityName": "SmsLog",
          "schema": {
            "$ref": "#/backend/entities/SmsLog"
          },
          "description": "Stores SMS logs associated with a receipt.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "receiptId",
              "description": "The unique ID of the receipt."
            },
            {
              "name": "smsLogId",
              "description": "The unique ID of the SMS log."
            }
          ]
        }
      },
      {
        "path": "/systemErrorLogs/{systemErrorLogId}",
        "definition": {
          "entityName": "SystemErrorLog",
          "schema": {
            "$ref": "#/backend/entities/SystemErrorLog"
          },
          "description": "Stores system error logs. Only accessible to super admins or backend services.",
          "params": [
            {
              "name": "systemErrorLogId",
              "description": "The unique ID of the system error log."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "roles_admin",
          "schema": {
            "$ref": "#/backend/entities/SystemErrorLog"
          },
          "description": "Marks a user as super admin. Existence of document grants admin privileges.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user with admin privileges."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore data structure is designed for the ReceiptRocket application, prioritizing security, scalability, and debuggability. It adheres to the core design principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), QAPs (Rules are not Filters), and Invariants.\n\n**Authorization Independence:**\n\n*   Authorization is handled without relying on hierarchical `get()` calls. Specifically, access to receipts and other subcollections is governed by denormalizing the `organizationId` into each document. This allows security rules to validate ownership directly without needing to traverse the data hierarchy.\n\n**Structural Segregation (Homogeneous Security Posture):**\n\n*   Each top-level collection (`organizations`, `systemErrorLogs`) is designed with a specific security profile. This avoids mixing data with different access requirements within the same collection, simplifying security rule definition and maintenance.\n\n**Access Modeling:**\n\n*   **Organizations:** The `organizations` collection stores organization profiles. Super admins have read access to all organization documents, while organizations have read/write access only to their own document.\n*   **Contacts:** Customer contacts are stored in a subcollection under their respective organization to enforce data isolation.\n*   **Receipts:** Receipts are stored in a subcollection `organizations/{organizationId}/receipts`. This establishes a clear ownership relationship. The `organizationId` is denormalized within each receipt document to enforce authorization independence.\n*   **Email Logs/SMS Logs:** Logs are stored as subcollections of `receipts`. This allows easy retrieval of logs related to specific receipts and avoids top-level collection bloat. The logs inherit the access control of their parent receipts.\n*   **System Error Logs:** Stored in a top-level `systemErrorLogs` collection. Only super admins or backend services have write access to this collection for debugging and monitoring purposes.\n\n**QAPs (Rules are not Filters):**\n\n*   The structure enables secure `list` operations by avoiding reliance on data-based filtering in security rules. By segregating data based on access requirements (e.g., receipts owned by a specific organization), rules can efficiently authorize listing operations without needing to inspect the data within each document.\n\n**Super Admin Role:**\n\n*   The existence of a document in the `/roles_admin/{uid}` collection signifies super admin status. This enables simple and robust role-based access control without custom claims.\n"
  }
}
    