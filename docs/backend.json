{
  "entities": {
    "Organization": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Organization",
      "type": "object",
      "description": "Represents a business using the ReceiptRocket platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the organization entity."
        },
        "companyName": {
          "type": "string",
          "description": "The name of the company."
        },
        "logoUrl": {
          "type": "string",
          "description": "URL of the company logo stored in Cloudinary.",
          "format": "uri"
        },
        "email": {
          "type": "string",
          "description": "The company's email address.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "The company's phone number."
        },
        "address": {
          "type": "string",
          "description": "The company's physical address."
        },
        "primaryColor": {
          "type": "string",
          "description": "The primary color used for branding (e.g., in receipts)."
        },
        "accentColor": {
          "type": "string",
          "description": "The accent color used for branding (e.g., in receipts)."
        },
        "bodyFont": {
          "type": "string",
          "description": "The body font used for receipts, emails and sms."
        },
        "headlineFont": {
          "type": "string",
          "description": "The headline font used for receipts, emails, and sms."
        }
      },
      "required": [
        "id",
        "companyName",
        "email",
        "phoneNumber",
        "address"
      ]
    },
    "Receipt": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Receipt",
      "type": "object",
      "description": "Represents a digital receipt generated by the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the receipt entity."
        },
        "organizationId": {
          "type": "string",
          "description": "Reference to Organization. (Relationship: Organization 1:N Receipt)"
        },
        "customerName": {
          "type": "string",
          "description": "The name of the customer."
        },
        "customerEmail": {
          "type": "string",
          "description": "The email address of the customer.",
          "format": "email"
        },
        "customerPhoneNumber": {
          "type": "string",
          "description": "The phone number of the customer."
        },
        "items": {
          "type": "array",
          "description": "List of items in the receipt.",
          "items": {
            "type": "string"
          }
        },
        "discount": {
          "type": "number",
          "description": "Optional discount applied to the receipt."
        },
        "tax": {
          "type": "number",
          "description": "Optional tax applied to the receipt."
        },
        "receiptNumber": {
          "type": "string",
          "description": "Unique receipt number for the transaction."
        },
        "pdfUrl": {
          "type": "string",
          "description": "URL of the generated PDF receipt.",
          "format": "uri"
        },
        "sentViaEmail": {
          "type": "boolean",
          "description": "Indicates whether the receipt was sent via email."
        },
        "sentViaSms": {
          "type": "boolean",
          "description": "Indicates whether the receipt was sent via SMS."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the receipt was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "organizationId",
        "customerName",
        "customerEmail",
        "receiptNumber",
        "createdAt"
      ]
    },
    "EmailLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "EmailLog",
      "type": "object",
      "description": "Represents a log entry for an email sent by the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the email log entry."
        },
        "organizationId": {
          "type": "string",
          "description": "Reference to Organization. (Relationship: Organization 1:N EmailLog)"
        },
        "receiptId": {
          "type": "string",
          "description": "Reference to Receipt. (Relationship: Receipt 1:N EmailLog)"
        },
        "recipient": {
          "type": "string",
          "description": "The email address of the recipient.",
          "format": "email"
        },
        "status": {
          "type": "string",
          "description": "The status of the email (sent, delivered, failed)."
        },
        "errorMessage": {
          "type": "string",
          "description": "Error message if the email failed to send."
        },
        "sentAt": {
          "type": "string",
          "description": "Timestamp indicating when the email was sent.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "organizationId",
        "recipient",
        "status",
        "sentAt"
      ]
    },
    "SmsLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SmsLog",
      "type": "object",
      "description": "Represents a log entry for an SMS message sent by the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SMS log entry."
        },
        "organizationId": {
          "type": "string",
          "description": "Reference to Organization. (Relationship: Organization 1:N SmsLog)"
        },
        "receiptId": {
          "type": "string",
          "description": "Reference to Receipt. (Relationship: Receipt 1:N SmsLog)"
        },
        "phoneNumber": {
          "type": "string",
          "description": "The phone number the SMS was sent to."
        },
        "status": {
          "type": "string",
          "description": "The status of the SMS message (sent, delivered, failed)."
        },
        "apiResponse": {
          "type": "string",
          "description": "The response from the SMS API."
        },
        "sentAt": {
          "type": "string",
          "description": "Timestamp indicating when the SMS was sent.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "organizationId",
        "phoneNumber",
        "status",
        "sentAt"
      ]
    },
    "Template": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Template",
      "type": "object",
      "description": "Represents a template for receipts, emails, or SMS messages.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the template."
        },
        "organizationId": {
          "type": "string",
          "description": "Reference to Organization. (Relationship: Organization 1:N Template)"
        },
        "templateType": {
          "type": "string",
          "description": "The type of the template (receipt, email, sms)."
        },
        "templateContent": {
          "type": "string",
          "description": "The content of the template."
        },
        "description": {
          "type": "string",
          "description": "Descriptioon of the Template."
        }
      },
      "required": [
        "id",
        "organizationId",
        "templateType",
        "templateContent"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/organizations/{organizationId}",
        "definition": {
          "entityName": "Organization",
          "schema": {
            "$ref": "#/backend/entities/Organization"
          },
          "description": "Stores organization profiles.  Organizations can only be created via Signup, and are secured by their organizationId. Owners of organizationId can read/write.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/receipts/{receiptId}",
        "definition": {
          "entityName": "Receipt",
          "schema": {
            "$ref": "#/backend/entities/Receipt"
          },
          "description": "Stores receipts associated with each organization. Organization owners can read/write receipts associated with their organizationId.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "receiptId",
              "description": "The unique ID of the receipt."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/email_logs/{emailLogId}",
        "definition": {
          "entityName": "EmailLog",
          "schema": {
            "$ref": "#/backend/entities/EmailLog"
          },
          "description": "Stores email logs associated with each organization. Organization owners can read email logs associated with their organizationId.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "emailLogId",
              "description": "The unique ID of the email log."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/sms_logs/{smsLogId}",
        "definition": {
          "entityName": "SmsLog",
          "schema": {
            "$ref": "#/backend/entities/SmsLog"
          },
          "description": "Stores SMS logs associated with each organization. Organization owners can read SMS logs associated with their organizationId.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "smsLogId",
              "description": "The unique ID of the SMS log."
            }
          ]
        }
      },
      {
        "path": "/organizations/{organizationId}/templates/{templateId}",
        "definition": {
          "entityName": "Template",
          "schema": {
            "$ref": "#/backend/entities/Template"
          },
          "description": "Stores templates associated with each organization. Organization owners can read/write Templates associated with their organizationId.",
          "params": [
            {
              "name": "organizationId",
              "description": "The unique ID of the organization."
            },
            {
              "name": "templateId",
              "description": "The unique ID of the template."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore data structure is designed for the ReceiptRocket application, prioritizing security, scalability, and ease of debugging. Since Firebase Authentication is used only, and all authorization logic is managed within Firestore, a DBAC (Database-Based Access Control) approach is implemented. Key considerations include:\n\n**Authorization Independence:** The design avoids hierarchical authorization dependencies.  Instead of using `get()` calls in security rules, authorization data (such as organization ownership) is denormalized into subcollections where necessary. This ensures atomic operations and simplifies security rules. For example, receipts inherit the `organizationId` from their parent organization.\n\n**Structural Segregation:** Collections are segregated based on their security posture.  Private data, like organization profiles, are stored under a path-based ownership model (`/organizations/{organizationId}`).  This allows for straightforward security rules based on `request.auth.uid`.\n\n**Access Modeling:** A consistent approach is used for access control. Path-based ownership is employed for user-owned data (`/organizations/{organizationId}`). \n\n**QAPs (Rules Are Not Filters):** The structure enables secure `list` operations.  The homogeneous security posture of each collection, achieved through structural segregation, makes it possible to write rules that do not require filtering.\n\n**Invariants:**  The structure facilitates the maintenance of invariants such as ownership. The direct relationship between organizations and their related data (receipts, logs, templates) simplifies ownership-based security rules.\n\n**Justification for Paths:**\n*   `/organizations/{organizationId}`:  Stores organization profiles.  This path enforces ownership using the `organizationId`.\n*   `/organizations/{organizationId}/receipts/{receiptId}`: Stores receipts associated with an organization, enabling listing receipts for a specific organization. Authorization is managed through the `organizationId`.\n*   `/organizations/{organizationId}/email_logs/{emailLogId}`:  Stores email logs for each organization.  Authorization is managed through the `organizationId`.\n*   `/organizations/{organizationId}/sms_logs/{smsLogId}`: Stores SMS logs for each organization. Authorization is managed through the `organizationId`.\n*   `/organizations/{organizationId}/templates/{templateId}`: Stores templates for each organization. Authorization is managed through the `organizationId`.\n"
  }
}